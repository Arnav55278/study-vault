{% extends 'base.html' %}

{% block title %}{{ file.filename }} - StudyVault{% endblock %}

{% block content %}
<div class="container py-4">
    
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('folder_view', folder_id=folder.id) }}">{{ folder.name }}</a></li>
            <li class="breadcrumb-item active">{{ file.filename }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- File Info -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <!-- Preview -->
                <div class="card-body text-center py-5 bg-light">
                    {% if file.file_type == 'image' %}
                        <img src="{{ url_for('preview_file', file_id=file.id) }}" 
                             alt="{{ file.filename }}" 
                             class="img-fluid rounded" 
                             style="max-height: 500px;">
                    {% elif file.file_type == 'pdf' %}
                        <div class="mb-3">
                            <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 6rem;"></i>
                        </div>
                        <a href="{{ url_for('preview_file', file_id=file.id) }}" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-eye me-1"></i>View PDF
                        </a>
                    {% elif file.file_type == 'video' %}
                        <video controls class="w-100 rounded" style="max-height: 500px;">
                            <source src="{{ url_for('preview_file', file_id=file.id) }}" type="{{ file.mime_type }}">
                        </video>
                    {% elif file.file_type == 'audio' %}
                        <div class="mb-3">
                            <i class="bi bi-file-earmark-music text-warning" style="font-size: 6rem;"></i>
                        </div>
                        <audio controls class="w-100">
                            <source src="{{ url_for('preview_file', file_id=file.id) }}" type="{{ file.mime_type }}">
                        </audio>
                    {% else %}
                        <div>
                            <i class="{{ file.get_icon() }}" style="font-size: 6rem;"></i>
                        </div>
                    {% endif %}
                </div>
                
                <!-- File Details -->
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div>
                            <h4 class="mb-2">{{ file.filename }}</h4>
                            {% if file.description %}
                                <p class="text-muted">{{ file.description }}</p>
                            {% endif %}
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-success">
                                <i class="bi bi-download me-1"></i>Download
                            </a>
                            {% if current_user.is_authenticated %}
                                <button class="btn btn-outline-warning star-btn" data-type="file" data-id="{{ file.id }}">
                                    <i class="bi {{ 'bi-star-fill' if is_starred else 'bi-star' }}"></i>
                                </button>
                            {% endif %}
                            {% if file.share_token %}
                                <button class="btn btn-outline-primary" onclick="copyToClipboard('{{ url_for('shared_file', token=file.share_token, _external=True) }}')">
                                    <i class="bi bi-share"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Tags -->
                    {% if file.tags.count() > 0 %}
                        <div class="mt-3">
                            {% for tag in file.tags %}
                                <a href="{{ url_for('tag_view', slug=tag.slug) }}" class="tag">{{ tag.name }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots me-2"></i>Comments ({{ file.get_comments_count() }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if current_user.is_authenticated %}
                        <form action="{{ url_for('add_comment', file_id=file.id) }}" method="POST" class="mb-4">
                            {{ comment_form.hidden_tag() }}
                            <div class="d-flex gap-3">
                                <img src="{{ url_for('static', filename='avatars/' + current_user.avatar) }}" 
                                     alt="Avatar" class="comment-avatar"
                                     onerror="this.src='https://ui-avatars.com/api/?name={{ current_user.username }}&background=667eea&color=fff'">
                                <div class="flex-grow-1">
                                    {{ comment_form.content(class="form-control", placeholder="Write a comment...", rows=2) }}
                                    <button type="submit" class="btn btn-primary btn-sm mt-2">
                                        <i class="bi bi-send me-1"></i>Post Comment
                                    </button>
                                </div>
                            </div>
                        </form>
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <a href="{{ url_for('login') }}">Login</a> to post comments
                        </p>
                    {% endif %}
                    
                    <!-- Comments List -->
                    {% if comments %}
                        {% for comment in comments %}
                            <div class="comment-item">
                                <div class="d-flex gap-3">
                                    <img src="{{ url_for('static', filename='avatars/' + comment.author.avatar) }}" 
                                         alt="Avatar" class="comment-avatar"
                                         onerror="this.src='https://ui-avatars.com/api/?name={{ comment.author.username }}&background=667eea&color=fff'">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>{{ comment.author.username }}</strong>
                                                <small class="text-muted ms-2">{{ format_datetime(comment.created_at) }}</small>
                                            </div>
                                            {% if current_user.is_authenticated and (comment.user_id == current_user.id or current_user.is_admin) %}
                                                <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST" style="display:inline;">
                                                    <button type="submit" class="btn btn-sm text-danger" onclick="return confirm('Delete this comment?')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                        <p class="mb-0 mt-1">{{ comment.content }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                            <p class="mt-2">No comments yet. Be the first to comment!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- File Stats -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>File Details</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Type</td>
                            <td><span class="badge bg-secondary">{{ file.file_type }}</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Size</td>
                            <td>{{ file.get_size_formatted() }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Downloads</td>
                            <td><i class="bi bi-download text-success me-1"></i>{{ file.download_count }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Views</td>
                            <td><i class="bi bi-eye text-primary me-1"></i>{{ file.view_count }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Uploaded</td>
                            <td>{{ format_datetime(file.uploaded_at) }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Uploader</td>
                            <td>
                                <a href="{{ url_for('public_profile', username=file.uploader.username) }}">
                                    {{ file.uploader.username }}
                                </a>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Rating -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-star me-2"></i>Rating</h6>
                </div>
                <div class="card-body text-center">
                    {% set avg_rating = file.get_average_rating() %}
                    <div class="mb-2">
                        <span class="fs-2 fw-bold text-warning">{{ "%.1f"|format(avg_rating) }}</span>
                        <span class="text-muted">/5</span>
                    </div>
                    <div class="text-warning mb-2">
                        {% for i in range(5) %}
                            {% if i < avg_rating|int %}
                                <i class="bi bi-star-fill fs-4"></i>
                            {% elif i < avg_rating %}
                                <i class="bi bi-star-half fs-4"></i>
                            {% else %}
                                <i class="bi bi-star fs-4"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <small class="text-muted">{{ file.get_rating_count() }} ratings</small>
                    
                    {% if current_user.is_authenticated %}
                        <hr>
                        <form action="{{ url_for('rate_file', file_id=file.id) }}" method="POST">
                            {{ rating_form.hidden_tag() }}
                            <p class="small text-muted mb-2">Rate this file:</p>
                            <div class="rating-input mb-2">
                                {% for i in range(1, 6) %}
                                    <i class="bi bi-star{% if user_rating and user_rating.rating >= i %}-fill{% endif %} fs-4" 
                                       style="cursor: pointer; color: {% if user_rating and user_rating.rating >= i %}#fbbf24{% else %}#e2e8f0{% endif %};"></i>
                                {% endfor %}
                                <input type="hidden" name="rating" value="{{ user_rating.rating if user_rating else 0 }}">
                            </div>
                            <button type="submit" class="btn btn-outline-warning btn-sm">
                                {{ 'Update' if user_rating else 'Submit' }} Rating
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            {% if current_user.is_authenticated %}
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            {% if file.uploaded_by == current_user.id %}
                                <a href="{{ url_for('edit_file', file_id=file.id) }}" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil me-1"></i>Edit File
                                </a>
                                <form action="{{ url_for('delete_file_route', file_id=file.id) }}" method="POST">
                                    <button type="submit" class="btn btn-outline-danger w-100" 
                                            onclick="return confirm('Delete this file permanently?')">
                                        <i class="bi bi-trash me-1"></i>Delete File
                                    </button>
                                </form>
                            {% endif %}
                            <a href="{{ url_for('report_content', item_type='file', item_id=file.id) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-flag me-1"></i>Report
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}